<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualize Data - Earthquake Sequence Mining</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-bottom: 60px;
        }
        .viz-card {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .table-container {
            max-height: 500px;
            overflow-y: auto;
        }
        .stats-card {
            text-align: center;
        }
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .badge {
            font-size: 0.9em;
        }
    </style>
</head>
<body class="py-5">
    <nav class="navbar navbar-dark bg-transparent">
        <div class="container">
            <a class="navbar-brand text-white fw-bold" href="index.html">
                <i class="bi bi-house-door-fill"></i> Back to Home
            </a>
        </div>
    </nav>

    <div class="container py-5">
        <div class="card viz-card">
            <div class="card-body p-5">
                <h1 class="card-title text-center mb-5">
                    <i class="bi bi-table text-primary"></i> Earthquake Data Table
                </h1>

                <!-- Year Selector -->
                <div class="row mb-4">
                    <div class="col-12">
                        <label class="form-label">Select Year:</label>
                        <select id="yearSelect" class="form-select form-select-lg">
                            <option value="">-- All Years --</option>
                        </select>
                        <span id="loadingYears" class="loading-spinner" style="display: none;"></span>
                    </div>
                </div>

                <!-- Summary Stats -->
                <div class="row mb-4" id="statsSection" style="display: none;">
                    <div class="col-md-3">
                        <div class="card text-center stats-card">
                            <div class="card-body">
                                <h3 class="text-primary" id="statTotalEvents">0</h3>
                                <p class="text-muted mb-0">Total Events</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center stats-card">
                            <div class="card-body">
                                <h3 class="text-success" id="statAvgMagnitude">0</h3>
                                <p class="text-muted mb-0">Avg Magnitude</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center stats-card">
                            <div class="card-body">
                                <h3 class="text-info" id="statAvgDepth">0</h3>
                                <p class="text-muted mb-0">Avg Depth (km)</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center stats-card">
                            <div class="card-body">
                                <h3 class="text-warning" id="statMaxMagnitude">0</h3>
                                <p class="text-muted mb-0">Max Magnitude</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title"><i class="bi bi-list"></i> All Events <span id="currentYearLabel"></span></h5>
                                <div class="table-container">
                                    <table class="table table-striped table-hover" id="dataTable">
                                        <thead class="table-dark position-sticky top-0">
                                            <tr>
                                                <th>Time</th>
                                                <th>Place</th>
                                                <th>Magnitude</th>
                                                <th>Depth (km)</th>
                                                <th>Latitude</th>
                                                <th>Longitude</th>
                                                <th>Location</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tableBody">
                                            <tr>
                                                <td colspan="7" class="text-center">
                                                    <div class="loading-spinner"></div>
                                                    <span class="ms-2">Loading data...</span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'http://localhost:5000/api';

        // Load years on page load
        $(document).ready(function() {
            loadYears();
            loadStats();
        });

        function loadYears() {
            $('#loadingYears').show();
            $.get(`${API_BASE}/years`, function(years) {
                const yearSelect = $('#yearSelect');
                yearSelect.empty();
                yearSelect.append('<option value="">-- All Years --</option>');
                years.forEach(year => {
                    yearSelect.append(`<option value="${year}">${year}</option>`);
                });
                $('#loadingYears').hide();
            }).fail(function() {
                $('#loadingYears').hide();
                $('#tableBody').html('<tr><td colspan="7" class="text-center text-danger">Failed to load years. Make sure API server is running: python api.py</td></tr>');
            });
        }

        function loadStats() {
            $.get(`${API_BASE}/stats`, function(stats) {
                if (stats.overall) {
                    $('#statTotalEvents').text(stats.overall.total_events || 0);
                    $('#statAvgMagnitude').text(stats.overall.avg_mag || 0);
                    $('#statAvgDepth').text(stats.overall.avg_depth || 0);
                    $('#statMaxMagnitude').text(stats.overall.max_mag || 0);
                    $('#statsSection').show();
                }
            });
        }

        function loadTable(year) {
            $('#tableBody').html('<tr><td colspan="7" class="text-center"><div class="loading-spinner"></div><span class="ms-2">Loading data...</span></td></tr>');

            const url = year ? `${API_BASE}/events/${year}` : `${API_BASE}/events/all`;
            $('#currentYearLabel').text(year ? `- ${year}` : '');

            $.get(url, function(events) {
                if (events.error) {
                    $('#tableBody').html(`<tr><td colspan="7" class="text-center text-danger">${events.error}</td></tr>`);
                    return;
                }

                if (!events || events.length === 0) {
                    $('#tableBody').html('<tr><td colspan="7" class="text-center text-muted">No data found</td></tr>');
                    return;
                }

                $('#tableBody').empty();
                events.forEach(event => {
                    const badgeClass = event.mag >= 7 ? 'bg-danger' : event.mag >= 6 ? 'bg-warning' : event.mag >= 5 ? 'bg-info' : 'bg-secondary';
                    const location = event.place || 'Unknown';
                    const latLon = event.lat !== undefined && event.lon !== undefined ?
                        `${event.lat.toFixed(2)}째, ${event.lon.toFixed(2)}째` : 'N/A';

                    $('#tableBody').append(`
                        <tr>
                            <td>${event.time || 'N/A'}</td>
                            <td>${location}</td>
                            <td><span class="badge ${badgeClass}">${event.mag || 'N/A'}</span></td>
                            <td>${event.depth || 'N/A'}</td>
                            <td>${event.lat ? event.lat.toFixed(2) : 'N/A'}째</td>
                            <td>${event.lon ? event.lon.toFixed(2) : 'N/A'}째</td>
                            <td>${latLon}</td>
                        </tr>
                    `);
                });
            }).fail(function() {
                $('#tableBody').html('<tr><td colspan="7" class="text-center text-danger">Failed to load data. Make sure API server is running: python api.py</td></tr>');
            });
        }

        // Year change handler
        $('#yearSelect').on('change', function() {
            loadTable($(this).val());
        });

        // Load all data by default
        loadTable('');
    </script>
</body>
</html>
